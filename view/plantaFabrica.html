<script>
    var myLineChart = null;
    var myLineChart2 = null;

    $(function () {
        data = new Date();
        $("#dataInicial").val(data.toISOString().slice(0, 10));
        $("#dataFinal").val(data.toISOString().slice(0, 10));
        carregarIndice();
    });
    function carregarIndice() {

        waitingDialog.show();
        $.ajax({
            type: "POST",
            url: '../ajax/carregarIndice.php',
            data: {
                idUsuario: $("#analistaSelecionado").val(),
                dataInicial: $("#dataInicial").val(),
                dataFinal: $("#dataFinal").val()
            },
            success: function (r) {
                r = $.parseJSON(r);
                console.log(r);
                if (r) {
                    if (myLineChart != null) myLineChart.destroy();
                    if (myLineChart2 != null) myLineChart2.destroy();
                    extrusora = r.indiceAnalista.Extrusora;
                    impressora = r.indiceAnalista.Impressora;
                    refile = r.indiceAnalista.Refile;
                    corte = r.indiceAnalista.Corte;
                    myLineChart = new Chart(document.querySelector('#doughnutChart'), {
                        type: 'doughnut',
                        data: {
                            labels: [
                                'Extrusao ',
                                'Impressao ',
                                'Corte ',
                                'Refile '
                            ],
                            datasets: [{
                                data: [extrusora, impressora, corte, refile],
                                backgroundColor: [
                                    'red',
                                    'yellow',
                                    'blue',
                                    'orange'
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            onClick(e) {
                                const activePoints = myLineChart.getElementsAtEventForMode(e, 'nearest', {
                                    intersect: true
                                }, false)
                                const [{
                                    index
                                }] = activePoints;
                                console.log(this.data.labels[index]);
                            }
                        }
                    });
                    myLineChart2 = new Chart(document.querySelector('#doughnutChart2'), {
                        type: 'bar',
                        data: {
                            labels: ['Falta de análise'],
                            datasets: [{
                                label: 'Pré-setup',
                                data: [r.quantidadeSemPreSetup],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)'
                                ],
                                borderColor: [
                                    'rgb(255, 99, 132)'
                                ],
                                borderWidth: 1
                            }, {
                                label: 'Ordens iniciadas',
                                data: [r.ordensPendentes],
                                backgroundColor: [
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 159, 64)'
                                ],
                                borderWidth: 1
                            }, {
                                label: 'Bobinas não analisadas',
                                data: [r.quantidadeBobinasNaoAnalisadas],
                                backgroundColor: [
                                    'rgba(255, 0, 0, 0.1)'
                                ],
                                borderColor: [
                                    'rgba(255, 0, 0)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            
                            onClick(e) {
                                const activePoints = myLineChart2.getElementsAtEventForMode(e, 'nearest', {
                                    intersect: true
                                }, false)
                                const [{
                                    index
                                }] = activePoints;
                                console.log(this.data.datasets[index]);
                            }
                        }
                    });
                }
            }
        });
        waitingDialog.hide();
    }

    function adicionarOPPendencia(idmaquina, numeroOP) {
        waitingDialog.show();
        $.ajax({
            type: "POST",
            url: '../ajax/salvarOrdemProducaoAreaTrabalho.php',
            async: true,
            data: {
                idmaquina: idmaquina,
                numeroOrdemProducao: numeroOP,
                flag: true
            },
            success: function (r) {
                var data = $.parseJSON(r);
                if (!data.status && data.naoMostraPendencia != '1') {
                    _alert(2, data.msg, false, false)
                } else {
                    window.location.href = 'areaTrabalho.php?maquina=1&idmaquina=' + idmaquina;
                }
                waitingDialog.hide();
            }
        });
    }

    function carregarPendencia() {
        $('.pendencias').show();
        $('.pendencias').append('<div class="alert alert-warning text-center loading-pendencia"><i class="fa fa-spinner fa-spin"></i></div>');
        $.ajax({
            type: "POST",
            url: '../ajax/carregarPendencia.php',
            data: {},
            success: function (r) {
                r = $.parseJSON(r);
                if (r) {
                    $('pendencias .alert-danger').remove();
                    $.each(r, function (i, val) {
                        if (val.maquina) {
                            $('.relacaoPendencia').append(
                                '<a href="#" onclick="adicionarOPPendencia(' + val.idmaquina + ', ' + val.numero + ')" class="list-group-item list-group-item-warning">Extrusora ' + (val.maquina ? val.maquina : '<span class="text-danger">?</span>') + ' - OP <b>' + val.numero + '</b> - ' + val.quantBobinaPesada + ' Bobinas pesadas <i class="fa fa-external-link pull-right" aria-hidden="true"></i></a>'
                            );
                        } else {
                            $('.relacaoPendencia').append(
                                '<li class="list-group-item list-group-item-default"">Extrusora ' + (val.maquina ? val.maquina : '<span class="text-danger">?</span>') + ' - OP <b>' + val.numero + '</b> - ' + val.quantBobinaPesada + ' Bobinas pesadas </li>'
                            );
                        }
                    });
                } else {
                    $('.pendencias').append('<div class="alert alert-warning">Nenhuma pendência encontrada. </div>');
                }
                $('.pendencias').show();
                $('.loading-pendencia').remove();
            }
        });
    }
    $(function () {
        carregarPendencia();
        $('.planta_fabrica .nav li a').click(function () {
            if ($(this).attr('carregarPendencia') == 1) {
                carregarPendencia();
            } else {
                $('.relacaoPendencia').html('');
                $('.pendencias').hide();
            }
        });
    });
    $(document).ready(function () {
        $("#dataInicial").change(function () {
            $("#dataFinal").prop('min', $("#dataInicial").val());
            $("#dataFinal").val('');
        })
        $("#buscaIndice").click(function () {
            carregarIndice();
        })
    })

</script>
<div class="container planta_fabrica">
    <div class="row ">
        <div class="col-sm-5 mt-10">
            <ul class="nav nav-pills nav">
                <!-- START BLOCK : lista-tipo-maquina -->
                <li class="{active} {menuDesativado}"
                    style="background-color: #EEE; border:1px solid #DDD; border-radius: 5px;"><a data-toggle="{toggle}"
                        href="#{tipoMaquinaAnchor}" carregarPendencia="{carregarPendencia}"
                        indice="{indice}">{tipoMaquina}</a></li>
                <!-- END BLOCK : lista-tipo-maquina -->
            </ul>
        </div>
        <div class="col-sm-7 ">
            <div class="panel panel-default area-trabalho-op">
                <div class="panel-heading  ">
                    <h3 class="panel-title">Indices desempenho Analista</h3>
                    <span class="pull-right clickable panel-collapsed"><i
                            class="fa fa-2x pl-xxs fa-chevron-circle-down"></i></span>
                </div>
                <div class="panel-body" style="display: none;">
                    <div class="row">
                        <div class="col-sm-4">
                            <label>Analista</label>
                            <select class="form-control" id="analistaSelecionado">
                                <!-- START BLOCK : lista-analistas -->
                                <option value="{idusuario}" {selected}>{analista}</option>
                                <!-- END BLOCK : lista-analistas -->
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <label>Data inicial</label>
                            <input class="form-control" type="date" id="dataInicial" />
                        </div>
                        <div class="col-sm-3">
                            <label>Data final</label>
                            <input class="form-control" type="date" id="dataFinal" min="" />
                        </div>
                        <div class="col-sm-2">
                            <label>Buscar</label>
                            <a id="buscaIndice" class="glyphicon glyphicon-search btn btn-primary"></a>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <!-- Doughnut Chart -->
                            <canvas id="doughnutChart" style="max-height: 200px;"></canvas>
                            <!-- End Doughnut CHart -->
                        </div>
                        <div class="col-sm-6">
                            <!-- Doughnut Chart -->
                            <canvas id="doughnutChart2" style="max-height: 200px;"></canvas>
                            <!-- End Doughnut CHart -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="tab-content planta-fabrica">
        <!-- START BLOCK : lista-bloco-maquina -->
        <div class="tab-pane fade in {active}" id="{tipoMaquinaAnchor}">
            <h3>{tipoMaquina}</h3>
            <div class="row">
                <!-- START BLOCK : lista-maquina -->
                <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <a href="areaTrabalho.php?maquina={idtipoMaquina}&idmaquina={idmaquina}" title="{mensagemDelay}">
                        <div class="well well-lg text-center maquina-atalho-{classeMaquina} {classeDelay}">
                            {tipoMaquina} {maquina}
                            <i class="{iconeDelay}"></i>
                        </div>
                    </a>
                </div>
                <!-- END BLOCK : lista-maquina -->
            </div>
        </div>

        <!-- END BLOCK : lista-bloco-maquina -->
        <div class="row">
            <div class="col-xs-12">
                <hr>
                <span><b>Legenda: </b></span>
                <i class="fa fa-exclamation-triangle"></i>
                <span>Máquina ociosa</span>
            </div>
        </div>

        <div class="pendencias" style="display: none;">
            <hr>
            <h4>Relação de OPs iniciadas sem nenhuma análise do analista de qualidade</h4>
            <ul class="list-group relacaoPendencia">
            </ul>
        </div>
    </div>
</div>